# nginx.conf

# Docker interner DNS für Lazy-Host-Auflösung
resolver 127.0.0.11 valid=30s;

server {
    listen 80;
    server_name localhost;

    # -------- Angular SPA --------
    root /usr/share/nginx/html;
    index index.html;

    # SPA Fallback für Angular-Routing
    location / {
        try_files $uri $uri/ /index.html;
    }

    # -------- API Reverse Proxy (Lazy DNS) --------
    # Upstream-Hosts werden erst bei Requests aufgelöst
    set $users_upstream koku-users;
    set $customers_upstream koku-customers;
    set $promotions_upstream koku-promotions;
    set $activities_upstream koku-activities;
    set $products_upstream koku-products;
    set $documents_upstream koku-documents;
    set $files_upstream koku-files;
    set $carddav_upstream koku-carddav;

    location /services/users/ {
        rewrite /services/users/(.*) /$1 break;
        proxy_pass http://$users_upstream:8420;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /services/customers {
        rewrite /services/customers/(.*) /$1 break;
        proxy_pass http://$customers_upstream:8320;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /services/promotions {
        rewrite /services/promotions/(.*) /$1 break;
        proxy_pass http://$promotions_upstream:8520;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /services/activities {
        rewrite /services/activities/(.*) /$1 break;
        proxy_pass http://$activities_upstream:8620;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /services/products {
        rewrite /services/products/(.*) /$1 break;
        proxy_pass http://$products_upstream:9320;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /services/files {
        rewrite /services/files/(.*) /$1 break;
        proxy_pass http://$files_upstream:8020;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /services/documents {
        rewrite /services/documents/(.*) /$1 break;
        proxy_pass http://$documents_upstream:8720;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /services/carddav {
        rewrite /services/carddav/(.*) /$1 break;
        proxy_pass http://$carddav_upstream:8220;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # -------- Logging --------
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;
}
